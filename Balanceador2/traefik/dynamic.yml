# TRAEFIK DYNAMIC CONFIG - BALANCEADOR 2


tls:
  certificates:
    - certFile: /etc/traefik/certs/sigpol.crt   # Certificado público TLS para servir HTTPS
      keyFile: /etc/traefik/certs/sigpol.key    # Clave privada asociada al certificado

http:
  routers:
    redirect-to-https:
      entryPoints:
        - "web"                                
      rule: "Host(`sigpol`)"                    # Aplica solo si el host solicitado es 'sigpol'
      middlewares:
        - redirect-to-https                     # Middleware que fuerza redirección a HTTPS
      service: noop@internal                    # Servicio interno vacío

    websecure:
      entryPoints:
        - "websecure"                           # Escucha en el entrypoint websecure (puerto 443)
      rule: "Host(`sigpol`)"                    # Aplica solo si el host solicitado es 'sigpol'
      service: web-servers                      # Balanceador de servidores web
      tls: {}                                   # Activa TLS usando el certificado
      middlewares:
        - add-balancer-headers                  # Middleware que añade cabeceras personalizadas

  middlewares:
    redirect-to-https:
      redirectScheme:
        scheme: https                           # Redirige tráfico HTTP a HTTPS
        permanent: true                         # Redirección permanente (301)

    add-balancer-headers:
      headers:
        customRequestHeaders:
          X-Balancer: "Traefik2"                # Cabecera personalizada para identificar este balanceador

  services:
    web-servers:
      loadBalancer:
        servers:
          - url: "http://192.168.1.30:8080"     # web1
          - url: "http://192.168.1.30:8081"     # web2
          - url: "http://192.168.1.31:8082"     # web3
          - url: "http://192.168.1.31:8083"     # web4
        healthCheck:
          path: /login.php                      # Endpoint usado para comprobar salud de los servidores
          interval: "10s"                       # Intervalo de chequeo cada 10 segundos
          timeout: "3s"                         # Tiempo máximo de espera para cada chequeo
